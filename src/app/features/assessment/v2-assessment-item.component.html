<div class="card mb-3 v2-assessment-card shadow-sm">
  <div class="card-body py-3">
    <!-- Header Row: Group info -->
    <div class="d-flex align-items-start mb-3">
      <div class="item-number me-3">
        <div class="badge bg-secondary rounded-pill">{{ itemNumber }}</div>
      </div>
      <div class="flex-grow-1">
        <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
          <h6 class="mb-0 text-dark fw-bold">{{ group.name }}</h6>
          <span class="badge" [class]="group.type === 'Technology' ? 'bg-primary' : 'bg-success'">
            <i [class]="group.type === 'Technology' ? 'bi bi-cpu' : 'bi bi-diagram-2'"></i>
            {{ group.type }}
          </span>
          <span class="badge bg-info small">
            <i class="bi bi-bookmark"></i>
            {{ getFunctionCapabilityName(group.function_capability_id) }}
          </span>
          <button class="btn btn-sm btn-outline-secondary ms-auto"
                  (click)="toggleDetails()"
                  type="button">
            <i [class]="showDetails ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"></i>
            {{ showDetails ? 'Hide' : 'Show' }} Stages
          </button>
        </div>
        <div *ngIf="showDescription" class="text-muted small">{{ group.description }}</div>

        <!-- Stage progression indicator -->
        <div class="stage-progression mt-2">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <small class="text-muted fw-semibold">Maturity Stages:</small>
            <div *ngFor="let stage of getAvailableStages()"
                 class="badge"
                 [class]="getStageBadgeClass(stage.id)"
                 [title]="getStageImplementation(stage.id)?.description || stage.name">
              <i [class]="getStageIcon(stage.id)"></i>
              {{ stage.name }}
            </div>
          </div>
        </div>
      </div>
      <div class="auto-save-indicator" *ngIf="isAutoSaving">
        <small class="text-muted">
          <i class="bi bi-arrow-clockwise spin"></i> Saving...
        </small>
      </div>
    </div>

    <!-- Stage Details (collapsible) -->
    <div class="stage-details mb-3" *ngIf="showDetails">
      <div class="card bg-light">
        <div class="card-body p-3">
          <h6 class="card-title text-muted small mb-2">
            <i class="bi bi-info-circle"></i> Implementation Details by Stage
          </h6>
          <div class="stage-list">
            <div *ngFor="let stage of getAvailableStages()" class="stage-detail-item mb-2">
              <div class="d-flex align-items-start">
                <div class="badge me-2" [class]="getStageBadgeClass(stage.id)">
                  <i [class]="getStageIcon(stage.id)"></i>
                </div>
                <div class="flex-grow-1">
                  <strong class="small">{{ stage.name }}</strong>
                  <p class="mb-0 small text-muted">
                    {{ getStageImplementation(stage.id)?.description || 'No description available' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assessment Controls Row -->
    <div class="assessment-controls">
      <div class="row g-3">
        <!-- Achieved Stage -->
        <div class="col-md-3">
          <label class="form-label fw-semibold small text-muted" [for]="'achieved_' + group.id">
            <i class="bi bi-check-circle"></i> Achieved Stage
          </label>
          <select class="form-select"
                  [ngModel]="achievedStageId"
                  (ngModelChange)="onAchievedStageChange($event)"
                  [id]="'achieved_' + group.id"
                  [name]="'achieved_' + group.id">
            <option [ngValue]="0">None (Not Started)</option>
            <option *ngFor="let stage of getAvailableStages()" [ngValue]="stage.id">
              {{ stage.name }}
            </option>
          </select>
          <small class="form-text text-muted">Highest completed stage</small>
        </div>

        <!-- Target Stage -->
        <div class="col-md-3">
          <label class="form-label fw-semibold small text-muted" [for]="'target_' + group.id">
            <i class="bi bi-arrow-right-circle"></i> Target Stage
          </label>
          <select class="form-select"
                  [ngModel]="targetStageId"
                  (ngModelChange)="onTargetStageChange($event)"
                  [id]="'target_' + group.id"
                  [name]="'target_' + group.id"
                  [disabled]="achievedStageId === 0 || getAvailableTargetStages().length === 0">
            <option [ngValue]="null">None (Fully Implemented)</option>
            <option *ngFor="let stage of getAvailableTargetStages()" [ngValue]="stage.id">
              {{ stage.name }}
            </option>
          </select>
          <small class="form-text text-muted">Stage currently working on</small>
        </div>

        <!-- Implementation Status -->
        <div class="col-md-3">
          <label class="form-label fw-semibold small text-muted" [for]="'status_' + group.id">
            <i class="bi bi-speedometer2"></i> Implementation Status
          </label>
          <select class="form-select"
                  [ngModel]="implementationStatus"
                  (ngModelChange)="onStatusChange($event)"
                  [id]="'status_' + group.id"
                  [name]="'status_' + group.id">
            <option *ngFor="let status of statusOptions" [ngValue]="status">{{ status }}</option>
          </select>
        </div>

        <!-- Notes -->
        <div class="col-md-3">
          <label class="form-label fw-semibold small text-muted" [for]="'notes_' + group.id">
            <i class="bi bi-sticky"></i> Notes
          </label>
          <textarea class="form-control"
                    rows="2"
                    [ngModel]="notes"
                    (ngModelChange)="onNotesChange($event)"
                    [id]="'notes_' + group.id"
                    [name]="'notes_' + group.id"
                    placeholder="Add notes..."></textarea>
        </div>
      </div>
    </div>
  </div>
</div>
